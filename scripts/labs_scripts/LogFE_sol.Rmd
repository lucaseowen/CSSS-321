---
title: "Log transformation and the Fixed Effects model"
author: "Lucas Owen"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(questionr)
library(stargazer)
library(tidyverse)
rm(list = ls())
```



# Prerequisite

```{r}

# load data
gapminder <- read_csv("data/gapminder2.csv")
polity <- read_csv("data/polity2.csv")
```


# Explore missing data

Missing data may introduce selection bias. Thus, during cleaning, analyze the source of missingness. Merge datasets `gapminder2.csv` and `polity2.csv`, then report the amount of missing data.


```{r}

# merge data, but first check out the names¡

# change the names¡

# now merge

merged_df <- full_join(gapminder, polity,
                   by = c("cntry"="country","year"="year"))

# create two new variables:

## one with the log of gdpPercap
## one dividing gdpPercap by 1000

merged_df$ln_gdpPercap <- log(merged_df$gdpPercap)
merged_df$gdpPercap <- merged_df$gdpPercap/1000


# check missigness
questionr::freq.na(merged_df)

# For a single variable
mean(is.na(merged_df$lifeExp))

# check missigness for each variable
df_na <- ifelse(is.na(merged_df), 1, 0)
colMeans(df_na)

```


# Statistical analysis


## Pooled model


In this section, we will fit a pooled model, formally:

$$
Y_{it} = \alpha + \beta X_{it} + \epsilon_{it} 
$$

Run this pooled model in three different specifications, each with `lifeExp` as the outcome variable. In the first model, regress the outcome on `gdpPercap`; in the second, regress it on `ln_gdpPercap`; and in the third, regress it on both `ln_gdpPercap` and `polity`.

```{r}
lm1 <- lm(lifeExp ~ gdpPercap, data=merged_df)
lm2 <- lm(lifeExp ~ ln_gdpPercap, data=merged_df)
lm3 <- lm(lifeExp ~ ln_gdpPercap + polity, data=merged_df)

```


```{r,results='asis', warning=F}
stargazer(lm1, lm2, lm3,
          type="text")

```





## Country fixed effects model

Now, we will employ a **country fixed effects** model. Recall that our units ($N$) are countries, and for each country we have several observations that refer to a particular period of time ($T$). Formally:

$$
Y_{it} = \alpha_i + \beta X_{it} + \epsilon_{it} 
$$


By including the variable `country`, the model will automatically generate dummy variables for each country within the variable. The coefficients associated with each country represent the country-specific intercepts. While there are situations where these coefficients can be interpreted, it is not always necessary to do so.


```{r}
lm4 <- lm(lifeExp ~ gdpPercap + cntry, data=merged_df)
lm5 <- lm(lifeExp ~ ln_gdpPercap + cntry, data=merged_df)
lm6 <- lm(lifeExp ~ ln_gdpPercap + polity + cntry, data=merged_df)
```


```{r, results='asis', warning=F}
stargazer(lm4,lm5,lm6,
          omit = "cntry",
          add.lines = list(c("Country Fixed Effects", "Yes", "Yes", "Yes")), 
          type="text")

```

## Because of autocorrelation, our standard errors are going to be overly small! We need to correct them

```{r, warning=F}
library(estimatr)
library(stargazer)

# Run robust regressions
lm4 <- lm_robust(lifeExp ~ gdpPercap + cntry, data=merged_df, clusters=cntry, se_type="stata")
lm5 <- lm_robust(lifeExp ~ ln_gdpPercap + cntry, data=merged_df, clusters=cntry, se_type="stata")
lm6 <- lm_robust(lifeExp ~ ln_gdpPercap + polity + cntry, data=merged_df, clusters=cntry, se_type="stata")

# Prepare coefficient and SE matrices using starprep()
models_prepped <- starprep(lm4, lm5, lm6, se_type="stata", clusters=merged_df$cntry)

# Convert lm_robust objects to standard lm objects for stargazer compatibility
lm4_standard <- lm(lifeExp ~ gdpPercap + cntry, data=merged_df)
lm5_standard <- lm(lifeExp ~ ln_gdpPercap + cntry, data=merged_df)
lm6_standard <- lm(lifeExp ~ ln_gdpPercap + polity + cntry, data=merged_df)

# Use stargazer with overridden coef and se
stargazer(lm4_standard, lm5_standard, lm6_standard,
          coef = list(models_prepped$coefficients[,1], 
                      models_prepped$coefficients[,2], 
                      models_prepped$coefficients[,3]),
          se = list(models_prepped$std.errors[,1], 
                    models_prepped$std.errors[,2], 
                    models_prepped$std.errors[,3]),
          omit = "cntry",
          add.lines = list(c("Country Fixed Effects", "Yes", "Yes", "Yes")), 
          type = "text")

```


## 2-way fixed effects model

If in addition to country-specific intercepts ($\alpha_i$) we can also include period-specific dummies ($\gamma_{t}$), then we are running a **Two-Way Fixed Effects model**. Formally:


$$
Y_{it} = \alpha_{i}  +\gamma_{t} + \beta X_{it} + \epsilon_{it} 
$$


**IMPORTANT**: Ensure that you treat the period variable, year, as a categorical factor. Otherwise, the variable will not be split into dummy variables for each specific year.


```{r, warning=F}
# turn year into factor:

merged_df$year <- as.factor(merged_df$year)

# Run robust regressions
lm4 <- lm_robust(lifeExp ~ gdpPercap + cntry  + year, data=merged_df, clusters=cntry, se_type="stata")
lm5 <- lm_robust(lifeExp ~ ln_gdpPercap + cntry  + year, data=merged_df, clusters=cntry, se_type="stata")
lm6 <- lm_robust(lifeExp ~ ln_gdpPercap + polity + cntry + year, data=merged_df, clusters=cntry, se_type="stata")

# Prepare coefficient and SE matrices using starprep()
models_prepped <- starprep(lm4, lm5, lm6, se_type="stata", clusters=merged_df$cntry)

# Convert lm_robust objects to standard lm objects for stargazer compatibility
lm4_standard <- lm(lifeExp ~ gdpPercap + cntry + year, data=merged_df)
lm5_standard <- lm(lifeExp ~ ln_gdpPercap + cntry + year, data=merged_df)
lm6_standard <- lm(lifeExp ~ ln_gdpPercap + polity + cntry + year, data=merged_df)

# Use stargazer with overridden coef and se
stargazer(lm4_standard, lm5_standard, lm6_standard,
          coef = list(models_prepped$coefficients[,1], 
                      models_prepped$coefficients[,2], 
                      models_prepped$coefficients[,3]),
          se = list(models_prepped$std.errors[,1], 
                    models_prepped$std.errors[,2], 
                    models_prepped$std.errors[,3]),
          omit = c("cntry", "year"),
          add.lines = list(c("Country Fixed Effects", "Yes", "Yes", "Yes"), c("Year Fixed Effects", "Yes", "Yes", "Yes")), 
          type = "text")
```

